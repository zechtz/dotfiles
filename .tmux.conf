### -------------------------------
### 🐚 Default Shell & Command
### -------------------------------

# Many tmux plugins (fzf-tmux, tmux-sessionx, tmux-floax, etc.)
# assume a POSIX shell (bash/sh) for their scripts.
# Nushell is *not* POSIX-compliant, so if $SHELL=nu,
# those plugins crash instantly or "flash and close".
#
# Solution: Tell tmux itself to always use bash for plugins,
# while you can still run `nu` in panes manually (e.g. `tmux new -s dev nu`).
# This way:
#   - tmux internals + plugins = bash ✅
#   - interactive shell panes = nushell ✅
# set-option -g default-shell /bin/bash
# set-option -g default-command /bin/bash


### -------------------------------
### 📦 Prefix & Keybindings
### -------------------------------

# Unbind the default prefix (Ctrl-b) and set it to Ctrl-a (more ergonomic)
unbind C-b
set -g prefix C-a

# Allow sending the prefix key itself (Ctrl-a a)
bind a send-prefix

# Reload tmux config quickly with Prefix + r
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# Split panes using | and -
bind | split-window -h   # horizontal split
bind - split-window -v   # vertical split

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind C-k copy-mode


### -------------------------------
### 🎨 Terminal & Display Settings
### -------------------------------

# Better terminal color support
set-option -g default-terminal 'screen-254color'
set-option -g terminal-overrides ',xterm-256color:RGB'
set -g default-terminal "${TERM}"

# Start window indexing at 1 (instead of 0)
set -g base-index 1

# Don’t exit tmux when the last session is closed
set -g detach-on-destroy off

# Remove escape key delay for snappier vim usage
set -g escape-time 0

# Large history buffer (1 million lines)
set -g history-limit 1000000

# Renumber windows automatically after closing one
set -g renumber-windows on

# Integrate system clipboard
set -g set-clipboard on

# Status bar at bottom (macOS style)
set -g status-position bottom

# Center the window list
set -g status-justify centre

# Use vi keys in copy mode
setw -g mode-keys vi

#cursor shape doesn't change in tmux
set -g -a terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'

# Enable mouse mode for easy scrolling and selection
# set -g mouse off

### -------------------------------
### 🎨 Pane Border Styling
### -------------------------------

# Active pane border is magenta, inactive is grey
set -g pane-active-border-style 'fg=magenta,bg=default'
set -g pane-border-style 'fg=brightblack,bg=default'


### -------------------------------
### 🔌 Plugins (managed by TPM)
### -------------------------------

# Core TPM + common utilities
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'         # Copy to clipboard
set -g @plugin 'tmux-plugins/tmux-resurrect'    # Save/restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum'    # Auto-save/restore
set -g @plugin 'fcsonline/tmux-thumbs'          # Fuzzy select text

set -g @plugin 'sainnhe/tmux-fzf'               # FZF inside tmux
set -g @plugin 'wfxr/tmux-fzf-url'              # FZF URL opener
set -g @plugin 'omerxx/tmux-sessionx'           # Better session management
set -g @plugin 'omerxx/tmux-floax'              # Floating pop-ups

# Theme plugins
set -g @plugin 'tmux-plugins/tmux-online-status'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'catppuccin/tmux'


### -------------------------------
### ⚙️ Plugin Configuration
### -------------------------------

# Floax pop-up (floating window)
set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-border-color 'magenta'
set -g @floax-text-color 'blue'
set -g @floax-bind 'p'
set -g @floax-change-path 'true'

#####################################################
## Sessionx (session manager with zoxide support)
#####################################################
set -g @fzf-url-fzf-options '-p 60%,30% --prompt="   " --border-label=" Open URL "'
set -g @fzf-url-history-limit '2000'

set -g @sessionx-bind 'o'
set -g @sessionx-bind-zo-new-window 'ctrl-y'
set -g @sessionx-auto-accept 'off'
set -g @sessionx-custom-paths '/Volumes/Work/work/dotfiles'
set -g @sessionx-x-path '~/dotfiles'
set -g @sessionx-window-height '85%'
set -g @sessionx-window-width '75%'
set -g @sessionx-zoxide-mode 'on'
set -g @sessionx-custom-paths-subdirectories 'false'
set -g @sessionx-filter-current 'false'
set -g @continuum-restore 'on'
# Continuum auto-restore + nvim session strategy
set -g @resurrect-strategy-nvim 'session'

### -------------------------------
### 🎨 Catppuccin Theme Config
### -------------------------------

# Use Catppuccin "Macchiato" theme
set -g @catppuccin_flavor "macchiato"
set -g @catppuccin_status_background "none"
set -g @catppuccin_window_status_style "none"
set -g @catppuccin_pane_status_enabled "off"
set -g @catppuccin_pane_border_status "off"


### -------------------------------
### 📟 Statusline Customization
### -------------------------------

# Status bar background
set -g status-style 'bg=terminal'

# Online/Offline indicators
set -g @online_icon "ok"
set -g @offline_icon "nok"

# Left side: session name, current command, truncated path, zoom status
set -g status-left-length 100
set -g status-left ""
set -ga status-left "#{?client_prefix,#{#[bg=#{@thm_red},fg=#{@thm_bg},bold]  #S },#{#[bg=#{@thm_bg},fg=#{@thm_green}]  #S }}"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_maroon}]  #{pane_current_command} "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_blue}]  #{=/-32/...:#{s|$USER|~|:#{b:pane_current_path}}} "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]#{?window_zoomed_flag,│,}"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_yellow}]#{?window_zoomed_flag,  zoom ,}"

# Right side: battery + online status
set -g status-right-length 100
set -g status-right ""
set -ga status-right "#{?#{e|>=:10,#{battery_percentage}},#{#[bg=#{@thm_red},fg=#{@thm_bg}]},#{#[bg=#{@thm_bg},fg=#{@thm_pink}]}} #{battery_icon} #{battery_percentage} "
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none]│"
set -ga status-right "#[bg=#{@thm_bg}]#{?#{==:#{online_status},ok},#[fg=#{@thm_mauve}] 󰖩 on ,#[fg=#{@thm_red},bold]#[reverse] 󰖪 off }"


### -------------------------------
### 🪟 Window Look & Feel
### -------------------------------

# Automatic rename windows (use "Window" as default format)
set -wg automatic-rename on
set -g automatic-rename-format "Window"

# Window status line styling
set -g window-status-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-style "bg=#{@thm_bg},fg=#{@thm_rosewater}"
set -g window-status-last-style "bg=#{@thm_bg},fg=#{@thm_peach}"
set -g window-status-activity-style "bg=#{@thm_red},fg=#{@thm_bg}"
set -g window-status-bell-style "bg=#{@thm_red},fg=#{@thm_bg},bold"
set -gF window-status-separator "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}]│"

# Highlight active window
set -g window-status-current-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-current-style "bg=#{@thm_peach},fg=#{@thm_bg},bold"


### -------------------------------
### 🪄 Smart Vim/Neovim Integration
### -------------------------------

# Detect if current process is vim/nvim/fzf
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

# Hide status bar automatically inside vim/nvim/fzf
set-hook -g pane-focus-in 'if-shell "$is_vim" "set status off" "set status on"'
set-hook -g pane-focus-out 'set status on'


### -------------------------------
### 🚀 TPM Bootstrap (keep last)
### -------------------------------

# Install TPM if missing
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TPM (MUST be at the bottom)
run '~/.tmux/plugins/tpm/tpm'
